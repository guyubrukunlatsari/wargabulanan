<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LAPORAN JIMPITAN WARGA BULANAN RT 04 RW 01 LATSARI</title>
<style>
body { font-family:'Segoe UI',sans-serif; background:#0f0f0f; color:#f1f1f1; margin:0; padding:10px; }
h1 { text-align:center; color:#00ff88; margin-bottom:10px; font-size:1.2rem; }
.filter-container { display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-bottom:10px; font-size:0.8rem; }
.filter-container input, .filter-container button { background:#1a1a1a; border:1px solid #444; color:#fff; padding:5px 6px; border-radius:5px; font-size:0.8rem; }
.filter-container button { background:#00cc66; color:#000; font-weight:bold; cursor:pointer; transition:0.2s; }
.filter-container button:hover { background:#00ff88; }
.table-wrapper { overflow-x:auto; -webkit-overflow-scrolling: touch; margin-bottom:10px; }
table { width:100%; border-collapse:collapse; min-width:400px; font-size:0.75rem; background:#1a1a1a; }
thead th { position: sticky; top:0; background:#00cc66; color:#000; padding:6px 5px; }
th, td { padding:5px 6px; text-align:center; border-bottom:1px solid #333; word-break:break-word; }
td.hasil { text-align:right; color:#00ff99; font-weight:bold; min-width:120px; }
tr:nth-child(even){ background-color:#1e1e1e; }
tr:hover{ background-color:#2a2a2a; }
.pagination{ display:flex; justify-content:center; flex-wrap:wrap; gap:4px; margin-top:10px; font-size:0.75rem; }
.pagination button{ padding:4px 6px; border-radius:4px; }
.pagination button.active{ background:#00ff88; color:#000; transform:scale(1.05);}
.pagination button:disabled{ background:#333; color:#777; cursor:not-allowed; }
footer{ text-align:center; font-size:11px; color:#777; margin-top:15px; }
@media(max-width:500px){
  .filter-container input, .filter-container button{ width:100%; max-width:180px; margin-bottom:3px; }
  table th, table td{ font-size:0.65rem; padding:3px 4px; }
  h1{ font-size:1rem; }
}
</style>
</head>
<body>

<h1>LAPORAN JIMPITAN WARGA BULANAN RT 04 RW 01 LATSARI</h1>

<div class="filter-container">
  <label>Dari: <input type="date" id="startDate"></label>
  <label>Sampai: <input type="date" id="endDate"></label>
  <input type="text" id="searchBox" placeholder="üîé Cari semua kolom..." oninput="applyFilter()"/>
  <button onclick="resetFilter()">üîÑ Reset</button>
  <button onclick="exportPDF()">üìÑ Export PDF</button>
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>No</th>
        <th>Tanggal</th>
        <th>Nama Warga</th>
        <th>Alamat</th>
        <th>Jenis Iuran</th>
        <th>Jumlah (Rp)</th>
        <th>Keterangan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination"></div>
</div>

<footer>Data otomatis diperbarui dari Google Sheet</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// Link CSV publik yang sudah publish to web
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzjNwESJhj-eGvY4RH3dsV2hT7D4bvD-MohbrKWuVN1P5w7jUWtLoG1dw5Yf6ddboiZAPzY6wlYce/pub?gid=2060081132&single=true&output=csv";

let allData = [], filteredData = [], currentPage=1, rowsPerPage=10, currentKeyword="";

async function fetchSheet(){
  try{
    const res = await fetch(sheetUrl);
    const text = await res.text();
    const rows = text.split("\n").filter(r=>r.trim()!="").map(r=>r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
    const headers = rows[0].map(h=>h.replace(/"/g,"").trim());
    allData = rows.slice(1).map((r,i)=>{
      const obj={no:i+1};
      headers.forEach((h,j)=>obj[h]=r[j]?r[j].replace(/"/g,""):"");
      if(obj["Tanggal"]) obj["tanggalObj"]=new Date(obj["Tanggal"]);
      return obj;
    }).reverse();
    filteredData = allData;
    renderTable();
  }catch(e){
    document.querySelector("tbody").innerHTML=`<tr><td colspan="7">‚ùå Gagal memuat data: ${e.message}</td></tr>`;
  }
}

function renderTable(){
  const tbody = document.querySelector("tbody");
  const pagination = document.querySelector(".pagination");
  const startDateVal=document.getElementById("startDate").value;
  const endDateVal=document.getElementById("endDate").value;
  const startDate=startDateVal?new Date(startDateVal):null;
  const endDate=endDateVal?new Date(endDateVal):null;

  filteredData = allData.filter(r=>{
    let matchDate=true;
    if(startDate && endDate && r.tanggalObj) matchDate=r.tanggalObj>=startDate && r.tanggalObj<=endDate;
    let matchText=currentKeyword?Object.values(r).some(v=>String(v).toLowerCase().includes(currentKeyword)):true;
    return matchDate && matchText;
  });

  const dataToShow = filteredData.slice((currentPage-1)*rowsPerPage,currentPage*rowsPerPage);
  tbody.innerHTML="";
  if(dataToShow.length===0){ tbody.innerHTML="<tr><td colspan='7'>Tidak ada data</td></tr>"; pagination.innerHTML=""; return; }

  dataToShow.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${(currentPage-1)*rowsPerPage+i+1}</td>
      <td>${r["Tanggal"]||""}</td>
      <td>${r["Nama Warga"]||""}</td>
      <td>${r["Alamat"]||""}</td>
      <td>${r["Jenis Iuran"]||""}</td>
      <td class="hasil">${r["Jumlah (Rp)"]||""}</td>
      <td style="text-align:left">${r["Keterangan"]||""}</td>
    `;
    tbody.appendChild(tr);
  });

  const totalPages=Math.ceil(filteredData.length/rowsPerPage);
  pagination.innerHTML="";
  if(totalPages<=1) return;

  const prev=document.createElement("button");
  prev.textContent="‚¨ÖÔ∏è"; prev.disabled=currentPage===1; prev.onclick=()=>{currentPage--; renderTable();};
  pagination.appendChild(prev);

  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement("button");
    btn.textContent=i; if(i===currentPage) btn.classList.add("active");
    btn.onclick=()=>{currentPage=i; renderTable();};
    pagination.appendChild(btn);
  }

  const next=document.createElement("button");
  next.textContent="‚û°Ô∏è"; next.disabled=currentPage===totalPages; next.onclick=()=>{currentPage++; renderTable();};
  pagination.appendChild(next);
}

function applyFilter(){ currentKeyword=document.getElementById("searchBox").value.toLowerCase(); currentPage=1; renderTable(); }
function resetFilter(){ document.getElementById("searchBox").value=""; document.getElementById("startDate").value=""; document.getElementById("endDate").value=""; currentKeyword=""; currentPage=1; renderTable(); }

function exportPDF(){
  import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js').then(jsPDFModule=>{
    const { jsPDF }=jsPDFModule;
    const doc=new jsPDF(); let y=10; doc.setFontSize(10);
    doc.text(`Warga Bulanan RT 04 RW 01`,10,y); y+=8;
    filteredData.forEach(r=>{
      const line=`${r.no} | ${r["Tanggal"]||""} | ${r["Nama Warga"]||""} | ${r["Alamat"]||""} | ${r["Jenis Iuran"]||""} | ${r["Jumlah (Rp)"]||""} | ${r["Keterangan"]||""}`;
      if(y>280){ doc.addPage(); y=10; }
      doc.text(line,10,y); y+=6;
    });
    doc.save("Warga_Bulanan.pdf");
  });
}

fetchSheet();
</script>
</body>
</html>
