<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LAPORAN WARGA BULANAN RT 04 RW 01 LATSARI</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background-color: #0f0f0f; color: #f1f1f1; margin: 0; padding: 15px; }
  h1 { text-align: center; color: #00ff88; margin-bottom: 15px; font-size: 1.5rem; }

  .filter-container {
    display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; margin-bottom: 15px;
  }
  .filter-container input, .filter-container button {
    background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 6px 8px; border-radius: 6px; font-size: 0.9rem;
  }
  .filter-container button { background: #00cc66; color: #000; font-weight: bold; cursor: pointer; transition: 0.2s; }
  .filter-container button:hover { background: #00ff88; }

  .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table { width: 100%; border-collapse: collapse; background: #1a1a1a; min-width: 750px; }
  th, td { padding: 8px 10px; text-align: center; border-bottom: 1px solid #333; font-size: 0.85rem; }
  th { background-color: #00cc66; color: #000; }
  td.nominal { text-align: right; color: #00ff99; font-weight: bold; min-width: 120px; }
  td.foto img { max-width: 80px; max-height: 60px; border-radius: 3px; }
  tr:nth-child(even) { background-color: #1e1e1e; }
  tr:hover { background-color: #2a2a2a; }
  .highlight { background-color: #00ff44; color: #000; font-weight: bold; border-radius: 3px; padding: 0 2px; }

  .pagination { display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; margin-top: 15px; }
  .pagination button { font-size: 0.85rem; padding: 5px 8px; border-radius: 5px; }
  .pagination button.active { background: #00ff88; color: #000; transform: scale(1.1); }
  .pagination button:disabled { background: #333; color: #777; cursor: not-allowed; }

  footer { text-align: center; font-size: 12px; color: #777; margin-top: 20px; }

  @media (max-width: 600px) {
    .filter-container input, .filter-container button { width: 100%; max-width: 220px; }
    h1 { font-size: 1.2rem; }
    table th, table td { font-size: 0.75rem; padding: 6px 5px; }
    td.foto img { max-width: 60px; max-height: 40px; }
  }
</style>
</head>
<body>
<h1>LAPORAN WARGA BULANAN RT 04 RW 01 LATSARI</h1>

<div class="filter-container">
  <label>Dari: <input type="date" id="startDate"></label>
  <label>Sampai: <input type="date" id="endDate"></label>
  <input type="text" id="searchBox" placeholder="üîé Cari semua kolom..." />
  <button onclick="resetFilter()">üîÑ Reset</button>
  <button onclick="exportPDF()">üìÑ Export PDF</button>
</div>

<div class="table-wrapper">
<table>
  <thead>
    <tr>
      <th>NO</th>
      <th>TANGGAL</th>
      <th>NAMA WARGA</th>
      <th>PERIODE BAYAR</th>
      <th>NOMINAL (Rp)</th>
      <th>KETERANGAN</th>
      <th>FOTO</th>
    </tr>
  </thead>
  <tbody id="table-body"><tr><td colspan="7">‚è≥ Memuat data...</td></tr></tbody>
</table>
</div>

<div class="pagination" id="pagination"></div>
<footer>Data otomatis diperbarui dari Google Sheet</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
const sheetId="1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw";
const sheetName="Laporan Warga Bulanan";
const query=encodeURIComponent("SELECT A,B,C,D,E,F,G");
const url=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}&tq=${query}`;

let allData=[], filteredData=[], currentPage=1, rowsPerPage=10, currentKeyword="";

function parseDate(val){
  if(!val) return {text:"", raw:new Date("1970-01-01")};
  if(typeof val==="string" && val.includes("Date(")){
    const m=val.match(/Date\((\d+),(\d+),(\d+)/);
    if(m){ const d=new Date(m[1],m[2],m[3]); return {text:d.toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"}), raw:d}; }
  }
  const d=new Date(val);
  return {text:!isNaN(d)?d.toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"}):val, raw:!isNaN(d)?d:new Date("1970-01-01")};
}

fetch(url)
.then(res=>res.text())
.then(rep=>{
  try {
    const json=JSON.parse(rep.match(/google\.visualization\.Query\.setResponse\((.*)\)/)[1]);
    const rows=json.table.rows.map(r=>r.c.map(c=>c?c.v:""));
    allData=rows.map((r,i)=>{
      const t=parseDate(r[1]); // kolom B: TANGGAL
      return {
        no:r[0]||i+1,          // kolom A: NO
        tanggalText:t.text,
        tanggalObj:t.raw,
        nama:r[2]||"",          // kolom C: NAMA WARGA
        periode:r[3]||"",       // kolom D: PERIODE BAYAR
        nominal:r[4]||"",       // kolom E: NOMINAL
        ket:r[5]||"",           // kolom F: KETERANGAN
        foto:r[6]||""           // kolom G: FOTO
      };
    }).reverse();
    filteredData=allData; renderTable();
  } catch(err){
    document.getElementById("table-body").innerHTML=`<tr><td colspan="7">‚ùå Gagal memuat data: ${err.message}</td></tr>`;
  }
})
.catch(err=>{
  document.getElementById("table-body").innerHTML=`<tr><td colspan="7">‚ùå Gagal memuat data: ${err.message}</td></tr>`;
});

function highlightText(text, keyword){ 
  if(!keyword) return text; 
  const regex=new RegExp(`(${keyword.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')})`,'gi'); 
  return text.replace(regex,'<span class="highlight">$1</span>'); 
}

function getFilteredData(){
  const startDateVal=document.getElementById("startDate").value;
  const endDateVal=document.getElementById("endDate").value;
  const startDate=startDateVal?new Date(startDateVal):null;
  const endDate=endDateVal?new Date(endDateVal):null;
  return allData.filter(row=>{
    let matchDate=true;
    if(startDate) matchDate = matchDate && row.tanggalObj >= startDate;
    if(endDate) matchDate = matchDate && row.tanggalObj <= endDate;
    let matchText=currentKeyword?Object.values(row).some(val=>String(val).toLowerCase().includes(currentKeyword)):true;
    return matchDate && matchText;
  });
}

function renderTable(){
  filteredData=getFilteredData();
  const tbody=document.getElementById("table-body"); tbody.innerHTML="";
  const start=(currentPage-1)*rowsPerPage; const end=start+rowsPerPage;
  const dataToShow=filteredData.slice(start,end);
  if(dataToShow.length===0){ tbody.innerHTML=`<tr><td colspan="7">Tidak ada data</td></tr>`; document.getElementById("pagination").innerHTML=""; return; }
  dataToShow.forEach((row,index)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${row.no}</td>
      <td>${highlightText(row.tanggalText,currentKeyword)}</td>
      <td style="text-align:left">${highlightText(row.nama,currentKeyword)}</td>
      <td>${highlightText(row.periode,currentKeyword)}</td>
      <td class="nominal">${highlightText(row.nominal,currentKeyword)}</td>
      <td style="text-align:left">${highlightText(row.ket,currentKeyword)}</td>
      <td class="foto">${row.foto ? `<img src="${row.foto}" alt="Foto">` : ""}</td>
    `;
    tbody.appendChild(tr);
  });
  renderPagination();
}

function renderPagination(){
  const pagination=document.getElementById("pagination"); pagination.innerHTML="";
  const totalPages=Math.ceil(filteredData.length/rowsPerPage);
  if(totalPages<=1) return;
  const prev=document.createElement("button"); prev.textContent="‚¨ÖÔ∏è"; prev.disabled=currentPage===1; prev.onclick=()=>{currentPage--; renderTable();}; pagination.appendChild(prev);
  for(let i=1;i<=totalPages;i++){ const b=document.createElement("button"); b.textContent=i; if(i===currentPage) b.classList.add("active"); b.onclick=()=>{currentPage=i; renderTable();}; pagination.appendChild(b);}
  const next=document.createElement("button"); next.textContent="‚û°Ô∏è"; next.disabled=currentPage===totalPages; next.onclick=()=>{currentPage++; renderTable();}; pagination.appendChild(next);
}

document.getElementById("searchBox").addEventListener("input",()=>{ currentKeyword=document.getElementById("searchBox").value.toLowerCase(); currentPage=1; renderTable(); });
document.getElementById("startDate").addEventListener("change",()=>{currentPage=1; renderTable();});
document.getElementById("endDate").addEventListener("change",()=>{currentPage=1; renderTable();});

function resetFilter(){ 
  document.getElementById("searchBox").value=""; 
  document.getElementById("startDate").value=""; 
  document.getElementById("endDate").value=""; 
  currentKeyword=""; 
  filteredData=allData; 
  currentPage=1; 
  renderTable(); 
}

function exportPDF(){
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF('l','pt','a4');
  doc.setFontSize(12); 
  doc.text("LAPORAN WARGA BULANAN RT 04 RW 01 LATSARI",40,20);
  doc.autoTable({
    head:[["NO","TANGGAL","NAMA WARGA","PERIODE BAYAR","NOMINAL (Rp)","KETERANGAN","FOTO"]],
    body:filteredData.map((row,i)=>[
      row.no,row.tanggalText,row.nama,row.periode,row.nominal,row.ket,row.foto ? "ADA FOTO" : ""
    ]),
    startY:40,
    theme:'grid',
    styles:{fontSize:8, cellPadding:3}
  });
  doc.save("Laporan_Warga_Bulanan.pdf");
}
</script>
</body>
</html>
